{% from "icon.njk" import icon %}
{% set localeNav = nav[lang] or nav[site.defaultLang] %}
{% set sectionIcons = {
  "begin-with": "explore",
  "data-utilities": "image",
  "ai-capabilities": "navigation",
  "basic-workflows": "map",
  "faq": "emote-sad"
} %}
{% if localeNav %}
<div class="sidebar">
  <div class="sidebar__sections" role="tablist">
    {% for section in localeNav.sections %}
      {% set tabId = "sidebar-tab-" + section.key %}
      {% set panelId = "sidebar-panel-" + section.key %}
      {% set sectionIcon = sectionIcons[section.key] %}
      <button
        class="sidebar__section-btn{% if section.key == currentSection %} is-active{% endif %}"
        data-section-key="{{ section.key }}"
        type="button"
        role="tab"
        id="{{ tabId }}"
        aria-controls="{{ panelId }}"
        aria-selected="{% if section.key == currentSection %}true{% else %}false{% endif %}"
      >
        {% if sectionIcon %}
          <span class="sidebar__section-icon">{{ icon(sectionIcon) }}</span>
        {% endif %}
        <span class="sidebar__section-label">{{ section.label }}</span>
      </button>
    {% endfor %}
  </div>
  <div class="sidebar__section-panel">
    <div class="sidebar__section-tabs" role="tablist" aria-label="Section shortcuts">
      {% for section in localeNav.sections %}
        {% set sectionIcon = sectionIcons[section.key] %}
        <button
          class="sidebar__section-tab{% if section.key == currentSection %} is-active{% endif %}"
          type="button"
          data-section-tab="{{ section.key }}"
          aria-selected="{% if section.key == currentSection %}true{% else %}false{% endif %}"
          aria-label="{{ section.label }}"
        >
          {% if sectionIcon %}
            <span class="sidebar__section-tab-icon">{{ icon(sectionIcon) }}</span>
          {% endif %}
        </button>
      {% endfor %}
    </div>
    <div class="sidebar__nav-wrapper">
      <div class="sidebar__nav-panels">
      {% for section in localeNav.sections %}
        {% set tabId = "sidebar-tab-" + section.key %}
        {% set panelId = "sidebar-panel-" + section.key %}
        {% set isActive = section.key == currentSection %}
        <div
          class="sidebar__nav-panel{% if isActive %} is-active{% endif %}"
          id="{{ panelId }}"
          role="tabpanel"
          aria-labelledby="{{ tabId }}"
          data-section-panel="{{ section.key }}"
          {% if not isActive %}hidden aria-hidden="true"{% else %}aria-hidden="false"{% endif %}
        >
          {% set navItems = section.pages %}
          {% set navSectionKey = section.key %}
          {% include "nav-list.njk" %}
        </div>
      {% endfor %}
      </div>
    </div>
  </div>
  <div class="sidebar__footer">
    <div class="sidebar__about">
      <a href="/{{ lang }}/about/" class="sidebar__about-link">
        <span class="sidebar__footer-icon">{{ icon("user-2") }}</span>
        <span>About</span>
      </a>
    </div>
    <div class="sidebar__controls">
      <div class="sidebar__lang">

        <span class="sidebar__footer-icon">{{ icon("globe") }}</span>

        {% set langOptions = site.languages or [] %}

        {% set langLabel = lang | upper %}

        {% for option in langOptions %}

          {% if option.code == lang %}

            {% set langLabel = option.label or langLabel %}

          {% endif %}

        {% endfor %}

        <button class="lang-toggle" type="button" data-lang-toggle aria-haspopup="true" aria-expanded="false">

          <span class="sidebar__lang-label">{{ langLabel }}</span>

          <span class="sidebar__lang-caret">{{ icon("chevron-down") }}</span>

        </button>

        <div class="lang-menu" data-lang-menu role="menu">

          {% set currentSlug = currentNavId or slug or 'how-to-use-this-site' %}

          {% for option in site.languages %}

            {% set target = '/' + option.code + '/' + currentSection + '/' + currentSlug + '/' %}

            <a href="{{ target }}" class="{% if option.code == lang %}is-active{% endif %}" role="menuitem" data-router-ignore>{{ option.label }}</a>

          {% endfor %}

        </div>

      </div>

      {% set themeLabel = (site.i18n and site.i18n.themeToggle and (site.i18n.themeToggle[lang] or site.i18n.themeToggle[site.defaultLang])) or 'Theme toggle' %}
      <button class="chip theme-toggle" type="button" data-theme-toggle aria-pressed="false" aria-label="{{ themeLabel }}">
        <span class="theme-toggle__icon" data-theme-icon="moon">{{ icon("moon") }}</span>
        <span class="theme-toggle__icon" data-theme-icon="sun">{{ icon("sun") }}</span>
      </button>
    </div>
  </div>
</div>
{% else %}
<p style="color: var(--color-danger);">Navigation missing for {{ lang }}.</p>
{% endif %}
