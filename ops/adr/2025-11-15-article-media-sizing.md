# ADR: Article Media Width Clamp Fix (2025-11-15)

- Status: Accepted
- Date: 2025-11-15

## Context
- Standalone article images are wrapped in `.article-media__frame` and expected to max out at 300 px height while keeping their aspect ratio and cached width from Gyazo metadata.
- The CSS attempted to recompute `--article-media-height` inside the rule with `--article-media-height: min(var(--article-media-height, 300px), 300px)` and then referenced the same custom property in `calc(var(--article-media-aspect) * var(--article-media-height))`.
- Because CSS custom properties are textual, the self-reference stored the literal string `min(var(--article-media-height, 300px), 300px)` inside the property. When the browser evaluated the `calc()`, it received `calc(1108 / 1477 * min(var(--article-media-height, 300px), 300px))`, which is invalid.
- Once the `calc()` was invalid, the entire `width` declaration was dropped and the frame fell back to `width: auto`, stretching to the 720 px column width and leaving the images centered with excessive empty padding.

## Decision
1. Remove the self-referential assignment and let the inline style (or fallback) provide the concrete numbers: `width: min(100%, var(--article-media-width, 720px), calc(var(--article-media-aspect, 16 / 9) * var(--article-media-height, 300px)))`.
2. Keep the inline `style` attributes generated by `.eleventy.js` responsible for clamping height to 300 px and for passing `--article-media-width`, `--article-media-height`, and `--article-media-aspect`.
3. Retain the padding removal and other visual treatments so the frame hugs the bitmap without unwanted gutters.

## Consequences
- Images now respect their cached width/height ratio and shrink to the intended 200 px–300 px block instead of inflating to the full column.
- CLS stays fixed because the same metadata still drives the placeholder dimensions.
- No additional JS is required; the fix lives entirely in the CSS and the existing Eleventy helper.

## Postmortem: Why the first attempt failed
- I forgot that custom properties are pure tokens and cannot evaluate `min()`/`calc()` until they are consumed. Assigning `--article-media-height` to an expression that referenced itself created an invalid string, which later poisoned the `calc()` in the `width` rule.
- Because CSS silently drops invalid values, the layout looked “unchanged” even though the logic had technically run. Proper testing (e.g., checking computed styles or devtools warnings) would have surfaced the invalid `calc()` sooner.
