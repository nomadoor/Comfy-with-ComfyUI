# ADR: TOC Scroll Sync & Image Fade Hook (2025-11-14)

- Status: Accepted
- Date: 2025-11-14

## Context
- The previous TOC implementation relied on IntersectionObserver, which frequently highlighted the wrong heading (top showing bottom, bottom showing top) and didnÅft resync after lazy-loaded images shifted layout.
- Designers need smooth, accurate TOC states and offset-aware scrolling that respects the sticky header height.

## Decision
1. Replace the IntersectionObserver logic in src/assets/js/toc.js with a deterministic scroll-position approach. We precompute heading positions, subtract a layout offset (--header-height + --space-lg), and map the scroll position to the closest preceding heading.
2. Emit a custom imageFade:loaded event from src/assets/js/image-fade.js whenever a lazy image resolves, so the TOC can recompute heading positions after layout shifts.
3. Apply scroll-margin-top: calc(var(--header-height) + var(--space-lg)) to .article-body h2/h3, aligning anchor targets with the header-free viewport.
4. Bind TOC link clicks to the same offset logic (window.scrollTo({ behavior: "smooth" })) for consistent in-page navigation.

## Consequences
- TOC highlighting now remains stable regardless of scroll direction or image-loading delays.
- Anchor navigation no longer hides headings behind the sticky header.
- The JS bundle grows slightly (extra event listeners + position caching), but keeps dependencies minimal.
- Future components that modify layout height must fire imageFade:loaded-style events or call the TOC recompute helper.
